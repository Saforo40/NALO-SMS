<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saforo</title>
    <style>
        #contact {
            height: 25px;
            margin-bottom: 5px;
        }

        body {
            background-color: rgb(167, 167, 228);
            text-align: center;
            color: floralwhite;
        }
    </style>
</head>

<body>
    <label for="">Recepient Number:</label>
    <input type="text" id="contact" placeholder="recipient's number"> <br>
    <label for="">Message to be sent: </label>
    <textarea name="" id="message" placeholder="message to be sent" cols="30" rows="10"></textarea>

    <br>
    <input type="submit" value="Submit" onclick='makeCall()'>

    <p id="result"></p>
    <script>

        function makeCall() {
            let Contact = document.getElementById("contact").value;
            let Message = document.getElementById("message").value;

            fetch("https://sms.nalosolutions.com/smsbackend/clientapi/Resl_Nalo/send-message/", {
                method: "POST",


                body: JSON.stringify({
                    "username": "saforo",
                    "password": "OUw6Qvz6KulDpyS",
                    "msisdn": Contact,
                    "message": Message,
                    "sender_id": "Test",

                    // Send the initial SMS request to the backend
            fetch('/send-sms/', {
                method: 'POST',
                body: formData,

                }),
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                    //Displaying the first response in the statusBox
                document.getElementById('statusBox').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                console.log('Initial response received:', data);

                    //Connection to WebSocket to listen for DLR 
                const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                const socketUrl = `${protocol}${window.location.host}/ws/dlr-updates/`;
                const socket = new WebSocket(socketUrl);

                consol.log('Websocket connection opened');

                socket.onmessage = function(event) {
                    const dlrData = JSON.parse(event.data);

                    //Updating the statusBox with DLR information
                    const newParagraph = document.createElement('p');
                    newParagraph.textContent = dlrData.message;

                     // Replace the content of the statusBox with new DLR updates
                    document.getElementById('statusBox').innerHTML = ''; 
                    document.getElementById('statusBox').innerHTML = `<pre>${JSON.stringify(dlrData.message, null, 4)}</pre>`;

                    console.log('DLR Update received:', dlrData.message);
    
            }
            )
                .then(function (res) {

                    return res.json();
                }
                )
                .then(function (response) {
                    document.getElementById("result").innerHTML = JSON.stringify(response);

                }
                )

        }
    </script>
</body>

</html>
